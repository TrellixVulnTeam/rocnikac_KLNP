%%% Fiktivní kapitola s instrukcemi k PDF/A

\chapter{Algoritmus odhadu zpoždění}

Tato kapitola pospisuje hledání optimálního modelu pro popis pohybu vozidel na trase.

\bigbreak

Z toho jak je problém formulován vyplývá, že se má odhadovat zpoždění mezi dvěma refenčními body a jediné takové jsou zastávky na trase danného spoje. Proto cíl algortimu může být formulován jako vytvořit popis průběh trasy mezi každou dvojcí zastávek, které alesponˇ jeden spoj obsluhuje a jsou bezprostředně sousedící ve sledu zastávek ve směru jízdy tohoto spoje. Nechtˇ se dvojce bodů a spoj je obsluhůjící splnˇující předcházející předpoklad označuje jako A, B a S.

\section{Základní předpoklady}

Hned na začátek je potřeba ustanovit základní předpoklady, ze kterých bude vycházet sestrojený algoritmus.

\bigbreak

Zastávky je potřeba rozlišovat na jednotlivá nástupiště. Toto výrazně nezvýší počet dvojic zastávek A a B. -- Naprostá většina zastávek má pouze dvě nástupiště. Pro každý směr jedno. Pokud má více nástupištˇ, pak tak bývá v případech, kdy ze zastávky odjíždí spoje do  více směrů a tudíž pro každné nástupiště je jiná následující zastávka.

\bigbreak

Všechny spoje S bez ohladu na linku nebo dopravce jedou ze zastávky A do zastávky B po stejné trase a tedy vzdálenost je konstatní. -- Předpokládá se, že žáný dopravce neužívá jinou komunikaci a pro všechny platí pravidla silničního provozu stejně. V případě mimořádností se trasa může měnit, nicméně detekce mimořádností a jejich řešení je nad rámec této práce.

\bigbreak

Čas jízdy ze zastávky A do B závisí pouze na denní době. -- Vysvětleno výše navíc platí žádný z dopravců nedisponuje právem přednosti v jízdě před jiným dopravcem nebo výrazně výkonějším vozidlem.  Dojezdové časy mohou být ovlivněny jen charakterem řidiče, avšak toto není zjistitelné z poskytnutých dat a zárovenˇ se předpokládá, že charatery řidičů jsou rovnoměrně rozloženy mezi všechny dopravce a linky. Podle jízdních řádů některé linky jedou rychleji než jiné, avšak skutečné doba jízdenky je stejná. To že některý spoj zastávku projíždí a tím je rychlejší než jiný spoj není porušení tohoto předpokladu protože se jedná o dvě různé dvojce zastávek.

\bigbreak

Během jízdy mohou nastat mimořádnosti, které porušují výše uvedené předpoklady, nicméně detekce mimořádností a jejich řešení je nad rámec této práce a jejich počet je zanedbatelný, proto na statistické modely nebudou mít vliv.


\subsection{Analýza dat}

Z dat popsaných v kapitole (TODO link kap 2???) je potřeba získat všechny dvojce zastávek A, B a všechny oznámené polohy vozidel mezi nimi. Toto je možné z databáze popsané v kapitole (TOTO link pak 3) zjistit pomocí jízdních řádů a dále pomocí atributu \verb-dist_shape_traveled- uvedého u každé zastávky pro každý spoj získat i jednotlivé polohy vozidel.

\bigbreak

Toto je možné realizovat pomocí následujícího \gls{sql} dotazu.

TODO upravit a vylepsit tento dotaz
\begin{code}[frame=none]
select inn.id_trip,
	inn.id_stop,
	inn.lead_stop,
	departure_time,
	inn.lead_stop_departure_time,
	(inn.lead_stop_shape_dist_traveled - inn.shape_dist_traveled) as diff_shape_trav,
	trip_coordinates.inserted,
	(trip_coordinates.shape_dist_traveled - inn.shape_dist_traveled) as shifted_shape_trav,
	trip_coordinates.delay
FROM (
	SELECT id_trip, id_stop, shape_dist_traveled, departure_time,
		LEAD(id_stop, 1) OVER (PARTITION BY id_trip ORDER BY shape_dist_traveled) lead_stop,
		LEAD(shape_dist_traveled, 1) OVER (PARTITION BY id_trip ORDER BY shape_dist_traveled) lead_stop_shape_dist_traveled,
		LEAD(departure_time, 1) OVER (PARTITION BY id_trip ORDER BY shape_dist_traveled) lead_stop_departure_time
	FROM rides) as inn
	JOIN trip_coordinates
	ON trip_coordinates.id_trip = inn.id_trip and inn.lead_stop_shape_dist_traveled - inn.shape_dist_traveled > 1500 and trip_coordinates.shape_dist_traveled between inn.shape_dist_traveled and inn.lead_stop_shape_dist_traveled
\end{code}

\bigbreak

Nyní je pro představení si situalce uvedeno několik vizualizací těchto dat. Zejména pak s důrazem na rozlišnosti mezi průběhy tras mezi různými dvojcemi zastávek.

\bigbreak

Všechny diagramy níže a posléze algoritmy pracují s těmito daty jako body třírozměrného prostoru. Každý tento bod reprezentuje jedno hlášení o poloze vozidla. První dimenze bodu je denní doba (v grafech znázorněno jako počet sekund od půlnoci), druhá dimenze je vzdálenost od výchozí zastávky (znázorněno jako počet metrů) a třetí dimenze reprezentuje čas od vyjetí z výchozí stanice (počet sekund).

TODO obrazky kratka trasa s moc nekonzistentnimi daty, dlouha trasa hladka, dlouha trasa s anomaliemi, trasy s nedostatkem dat, trasy kde jsou pekne videt krizovatky (cca 5 prikaldu)


\section{Návrh modelu}

Z výše uvedených vizualizací dat vyplývá, že hledání univerzálního modelu popisující všechny možné průběhy tras je nereálné.

\bigbreak

Lepší je různé průběhy tras rozdělit podle jejich vlastností do kategorií a pro každou použít jiný model. Použité dílčí modely jsou:


\subsection{Lineární model}

Ačkoli je snaha tento model nahradit lepším, v některých situacích může jeho použití i na dále dávat smysl. Zejména pak v případech kdy není k dispozici dostatek dat a nebo je vzdálenost dvou zastávek natolik malá, že nemá smyl ani jakýkoliv odhat zpoždění dělat. (TODO do problemu: Lepší by bylo volit trasy s nejmenší dobou jízdy, ale čas jízdy je promněnlivý a težko se získá skutečná doba jízdy z dat. Navíc v praxi jsou vzdálenost a doba jízdy dostatečně závislé)

(TODO obrázek lineárního modelu)


\subsection{Polynomiální model}

Polynomiální model se hodí pro situace kdy je průběh trasy nějak ovlivněn vždy ve stejném úseku a má vliv na každý projíždějící spoj. Nebo se v průběhu dne pozvolna mění v závislosti na dopravním vytížení projížděných úseků.

\bigbreak

K tomuto dochází například v případech kdy spoj zastavuje ve městě a v následujících několika málo kilometrech jede pomaleji, poté zrychlý a dále opět vjede do města. Takový model se hodí spíše na delší trasy s plynulou jízdou.

\bigbreak

Pro spočítání polynomiálního modelu se využívá knihovna sklearn konkrétně algoritmus zvaný Rigde, který sám o sobě hledá linární závislosti, nicméně vstupní hodnoty jsou mezi sebou náležitě pronásobeny tak, aby simulovali polynomiální funkci. Toho se dosáhne pomocí funkce PolynomialFeatures. Optimální stupenˇ polynomu se zjistí spočítáním modelu pro každý stupenˇ v rozumných mezích a nakonec se zvolí ten s nejmenší chybou. (TODO jak moc detailně se ma toto popisovat?)

(TODO obrazek poly modelu)


\subsection{Model pomocí konkávního obalu}

Posledním a nejkomplikovanějším modelem, zasluhující nejvíce pozornosti, je popsání trasy za pomocí konkávního obalu bodů.

\bigbreak

Tato metoda vznikla jako řešení situace, kdy na trase exituje bod, který určité procento projíždějících spojů zdrží o netriviální dobu. Něco takového nastane pokud spoje projíždí světelnou křižovatkou nebo místem přek kterým se tvoří kolona vozidel. Zde dochází ke skové změně průběhu bodové funkce a spojité modely by s okolím tohoto kritického místa měly problém. Pro jeden takový bod by možná šlo navrhnout jednoduší řešení, nicméně je potřeba algoritmus, který umí pracovat s více kritickými body na trase. Například je nutné poradit si se situací zobrazené na diagramu (TODO link na obrazek), kde jsou na trase takové kritické body dva. V této modelové situaci je pro jednoduchost uvažováno, že se většina projíždějících spojů zdrží v prvním kritickém bodě, nebo v druhém, nebo se lehce zdrží v obou. Stakovým zdržením je počítáno v jízdním řádu a tedy vozidla, která projedou první kritický bod jedou na čas stejně tak jako vozidla v něm zdržená. O snížení nebo zvýšení případného zpoždění spoje je možno rozhodnout až po projetí druhého bodu. Jinými slovy na ose uplynulého času od vyjetí ze zastávky vzniká jakýsi podprostor v němž se zpoždění nemění. Pro jeho popis se využívá právě konkávní obal všech spojů, které přijely včas.














































f
