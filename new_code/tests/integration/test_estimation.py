import unittest
from datetime import timedelta, datetime
from pathlib import Path
import numpy as np
import matplotlib.pyplot as plt

from database import Database
from file_system import File_system
import tests.lib_tests

class TestEstimation(unittest.TestCase):
	worse = 0
	better = 0
	twice_better = 0
	ratio = []

	@staticmethod
	def compare_delays(old_ride_delay, new_ride_delay):
		old_np = np.array(old_ride_delay)
		new_np = np.array(new_ride_delay)

		print(old_np.std())
		print(new_np.std())
		TestEstimation.ratio.append(old_np.std()/new_np.std())
		if old_np.std() < new_np.std():
			TestEstimation.worse += 1
		if old_np.std() > new_np.std():
			TestEstimation.better += 1
		if old_np.std() > new_np.std() * 2:
			TestEstimation.twice_better += 1

		return old_np.std(), new_np.std()

	@staticmethod
	def compare_estimation(id_trip: int, sdt_dep: int, sdt_arr: int, db_old, db_new):

		old_delay = np.array(db_old.execute_fetchall("""
					SELECT delay, inserted 
					FROM trip_coordinates 
					WHERE id_trip = %s 
						AND shape_dist_traveled BETWEEN %s + 99 AND %s - 99
						AND inserted BETWEEN '2020-02-21 00:00:00' AND '2020-02-21 23:59:59'
					ORDER BY inserted, shape_dist_traveled""",
			(str(id_trip), str(sdt_dep), str(sdt_arr))))

		new_delay = np.array(db_new.execute_fetchall("""
					SELECT delay, inserted 
					FROM trip_coordinates 
					WHERE id_trip = %s 
						AND shape_dist_traveled BETWEEN %s + 99 AND %s - 99
						AND inserted BETWEEN '2020-02-21 00:00:00' AND '2020-02-21 23:59:59'
					ORDER BY inserted, shape_dist_traveled""",
			(str(id_trip), str(sdt_dep), str(sdt_arr))))

		assert (old_delay.shape[0] == new_delay.shape[0])
		if len(old_delay.shape) == 1:
			print('For trip: ' + str(id_trip), ' std between ' + str(sdt_dep) + ' and ' + str(sdt_arr) + ' no data has been found.')
			return

		old_ride_delay = [old_delay[0, 0]]
		new_ride_delay = [new_delay[0, 0]]
		last_inserted = old_delay[0, 1]

		to_return = []

		for i in range(old_delay.shape[0] - 1):
			if old_delay[i + 1, 1].timestamp() < last_inserted.timestamp() + 12 * 60 * 60:
				old_ride_delay.append(old_delay[i + 1, 0])
				new_ride_delay.append(new_delay[i + 1, 0])
			else:

				print('Trip: ' + str(id_trip), ' std between ' + str(sdt_dep) + ' and ' + str(sdt_arr) + ' variance is:')
				to_return.append(TestEstimation.compare_delays(old_ride_delay, new_ride_delay))
				old_ride_delay = [old_delay[i + 1, 0]]
				new_ride_delay = [new_delay[i + 1, 0]]

			last_inserted = old_delay[i + 1, 1]

		print('Trip: ' + str(id_trip), ' std between ' + str(sdt_dep) + ' and ' + str(sdt_arr) + ' variance is:')
		to_return.append(TestEstimation.compare_delays(old_ride_delay, new_ride_delay))
		return to_return

	def test_compare_estimation_534_421(self):
		old_database_connection = Database("vehicle_positions_database")
		new_database_connection = Database("vehicle_positions_fri_delay_estimation_database")

		TestEstimation.compare_estimation(2162, 24647, 31530, old_database_connection, new_database_connection)

		old_delay = np.array(old_database_connection.execute_fetchall("""
					SELECT delay, shape_dist_traveled 
					FROM trip_coordinates 
					WHERE id_trip = %s 
						AND shape_dist_traveled BETWEEN %s + 99 AND %s - 99
						AND inserted BETWEEN '2020-02-21 00:00:00' AND '2020-02-21 23:59:59'
					ORDER BY inserted, shape_dist_traveled""", ('2162', '24647', '31530')))

		new_delay = np.array(new_database_connection.execute_fetchall("""
					SELECT delay, shape_dist_traveled 
					FROM trip_coordinates 
					WHERE id_trip = %s 
						AND shape_dist_traveled BETWEEN %s + 99 AND %s - 99
						AND inserted BETWEEN '2020-02-21 00:00:00' AND '2020-02-21 23:59:59'
					ORDER BY inserted, shape_dist_traveled""", ('2162', '24647', '31530')))

		plt.plot(old_delay[:,1], old_delay[:,0], label="lineární")
		plt.plot(new_delay[:,1], new_delay[:,0], label="polynomiální")
		plt.xlabel('ujetá vzdálenost')
		plt.ylabel('zpoždění [s]')
		plt.savefig('compare_534_421.pdf')
		plt.show()

	def test_compare_all_estimations(self):

		old_database_connection = Database("vehicle_positions_database")
		new_database_connection = Database("vehicle_positions_fri_delay_estimation_database")

		models = File_system.load_all_models()

		stops_variances = []

		for model in models.items():
			print(model[1].dep_stop, model[1].arr_stop)
			all_stop_trips = np.array(new_database_connection.execute_fetchall("""
				SELECT schedule.id_trip, schedule.shape_dist_traveled, schedule.lead_stop_shape_dist_traveled
				FROM (
        SELECT id_trip, id_stop, shape_dist_traveled,
            LEAD(id_stop, 1) OVER (
                PARTITION BY id_trip ORDER BY shape_dist_traveled) lead_stop,
            LEAD(shape_dist_traveled, 1) OVER (
                PARTITION BY id_trip ORDER BY shape_dist_traveled) lead_stop_shape_dist_traveled
        FROM rides) AS schedule
				WHERE schedule.id_stop = %s and schedule.lead_stop = %s
				""",
				(model[1].dep_stop, model[1].arr_stop)))

			stop_variance = []

			for row in all_stop_trips:
				trip_variances = np.array(TestEstimation.compare_estimation(row[0], row[1], row[2], old_database_connection, new_database_connection))
				if len(trip_variances.shape) > 0:
					stop_variance.append([trip_variances[:,0].mean(), trip_variances[:,1].mean()])

			stop_variance = np.array(stop_variance)
			stops_variances.append([stop_variance[:,0].mean(), stop_variance[:,1].mean()])
			if stops_variances[-1][0] - stops_variances[-1][1] < -60:
				print()

		print('Finished')
		print('For ' + str(TestEstimation.better) + ' segments of trips is the new estimation better.')
		print('For ' + str(TestEstimation.twice_better) + ' segments of trips is the new estimation significantly better.')
		print('For ' + str(TestEstimation.worse) + ' segments of trips is the new estimation worse.')

		# print(str(stops_variances))
		# stops_variances = [[24.348737190770258, 6.832410500656806], [12.54656255527874, 10.036168564747966], [56.08982714853666, 20.18976200459874], [26.298920022977395, 24.798120646394473], [48.956084123303654, 27.113962361379865], [15.877589733188902, 5.825364361889991], [11.410110652107212, 7.265670560648666], [20.94691626566343, 21.964245687026857], [22.11162229822675, 18.97274620530987], [25.055168675696567, 23.76465594015154], [5.858163367624767, 6.9811814946120805], [9.754259698125486, 7.104346199963311], [29.007908335370114, 30.0652066005387], [26.45756232737914, 14.613342315934464], [50.23257976225629, 51.50430604932023], [19.324567731426427, 18.622604099418115], [24.110555966441183, 20.75682303648302], [42.374234481594534, 15.201533702333284], [17.89181004458412, 16.73177889824033], [11.979911035357498, 9.163270002686765], [15.746946721046662, 13.512866252317774], [41.51851407127004, 43.25386304707798], [34.547451625382905, 34.422536867648446], [20.365768042371208, 13.926320085035826], [11.392287728523295, 7.9714297462212125], [24.89308508867334, 6.995614246594508], [10.697523604516299, 10.395502371632382], [12.966987923884068, 9.054425674319774], [43.721558649583436, 40.38118296668295], [29.720225994054204, 15.583397348355499], [13.236261153313068, 13.11649583480187], [27.706225672467262, 28.579259531263432], [10.97543659181504, 10.224172068947919], [37.185827691839776, 7.8053058319990845], [13.265614960367536, 10.426551003347543], [9.647412264747224, 8.628927027878179], [40.19184417178598, 36.531008260410005], [25.158153803592047, 9.840614516437318], [21.790952916526354, 14.539911425778337], [28.954710722421346, 19.3465611439331], [20.637161760528087, 11.251165738808854], [20.398518465469916, 17.289963550174253], [49.238944611085365, 19.469936182851495], [15.994012118922578, 8.483923436825576], [18.009499346469074, 11.291213372562744], [20.553400437638622, 12.370574473984677], [17.18937284568989, 11.884064860816888], [18.55710667661834, 7.856709970897675], [9.509867750007178, 5.522097403333499], [8.19195420941533, 7.174129443541414], [23.78863204052721, 5.608942141862055], [19.604687702507583, 13.328646882063051], [15.220411701118467, 19.292707825589602], [39.24223833465775, 25.104418052626244], [38.277020907814475, 28.495247231454368], [28.4214275897237, 19.258115157687804], [91.13731615323151, 65.26499846555716], [5.540742797371824, 4.70106092590583], [20.504816320783434, 30.563427096608525], [16.038509433032157, 13.028758229525724], [16.66441992261952, 8.068360686195726], [16.308885222163962, 16.161345690809434], [54.805246089664934, 10.156774798937802], [18.42041317022588, 9.865556081032487], [10.316035672082874, 10.219306331391689], [20.824566207871396, 8.672165590628627], [21.067707259771222, 11.229940971424547], [11.435091414688, 16.590533502909658], [16.617157369649686, 14.150036069062134], [33.06699767906672, 13.731423861881726], [9.010682601843945, 6.95571957979463], [17.15737238054345, 13.765572401996524], [85.85848306823078, 25.498070260278116], [14.708199761442959, 9.03799732988655], [33.64513844324972, 29.59070001209714], [30.427084351623158, 7.936531215379647], [34.31994106047549, 37.937204446634375], [15.222129507240185, 10.510410408535776], [26.120777692711446, 15.143003969851012], [7.145634842003258, 7.271302803344739], [9.169145361806427, 8.145530938208834], [8.151963038308487, 8.550597689534321], [12.69238922996112, 10.766026346152223], [19.84021082792604, 23.18663250957768], [10.462408271382378, 14.764147982768735], [14.954809275468296, 4.608663939442517], [17.151894935026736, 12.354243931050442], [34.241910974430695, 12.547486610104404], [26.109014156055018, 13.054962913847868], [21.74044897485018, 23.442899564909954], [45.73710654519609, 44.68965143842275], [13.163827533887874, 15.884144613993483], [10.092045846849427, 9.23103499514203], [36.82087711306547, 28.28469765693732], [12.798982098078325, 8.404318558735353], [8.137552458878938, 4.053570567470624], [20.407419933906056, 12.960978783612232], [23.974163606266135, 13.262220168780862], [36.150089242755236, 31.908870482719376], [50.60069986660934, 52.38301762768343], [20.648195849221892, 132.98673102985603], [8.242016103998992, 8.458851299409073], [12.934030283465592, 10.421842071671257], [15.522176021735666, 13.454278907010167], [46.288427218943454, 19.399158993535224], [34.29804384918695, 26.13882894222385], [8.812972839441132, 8.326750067040873], [16.63222737794002, 11.758477257349433], [10.145025003577565, 11.747599254763735], [6.556795441822163, 6.4731407227378766], [34.96334882449789, 19.410724008893684], [5.730712910846794, 5.917542912752881], [48.60550175281574, 49.438067491867834], [11.555590313201481, 8.897177998534824], [3.8195843514335484, 3.8768672807607123], [22.91641961044474, 18.65827200966919], [12.04619299545111, 7.477009118940943], [30.40755068461897, 27.898610893520967], [75.81288826908857, 85.29393043181364], [28.078134656893763, 26.126665989307412], [5.063397215232333, 4.967216687972296], [56.98412546868767, 55.36193710140881], [21.653158863602982, 6.589236264027758], [21.44713293563678, 8.44077736029908], [7.420092299254743, 7.850717101173161], [25.43748834350216, 23.12492610958062], [62.71978926450062, 49.96604317511535], [14.186581230682345, 10.971628507518659], [23.076504668281867, 21.202267123954627], [11.366057876814427, 8.42523915713602], [26.13925507028238, 19.690751589255726], [13.53290736444094, 6.447855613083855], [18.78441408399055, 17.324545388564164], [12.312935228274776, 13.301089803293651], [7.750627941239306, 6.954478448618041], [7.500238582739217, 7.987823938676485], [19.011979032923968, 9.808214552704642], [32.27507073567375, 26.846314878994168], [21.257975856513603, 18.047617013157378], [25.970326692416794, 10.247732453657527], [53.3437502397053, 52.52134384760235], [13.653302815360124, 13.690143436252864], [10.289550570250313, 11.81358086608368], [20.01273749166827, 6.664726406440459], [23.408225325157186, 12.238340936640018], [13.982205636737856, 12.64806313130288], [89.83736594164098, 80.70326106413413], [11.13836429578685, 7.713000377312493], [19.950796603124047, 8.908829986580567], [22.575251705905, 15.670077769499615], [9.44145642956406, 5.867035107141358], [12.390838719507949, 11.673748076737597], [14.75859545481971, 19.934473221270462], [36.503678551285596, 28.330013063700896], [33.43413693725531, 24.771992550267182], [24.08965116048912, 22.7859881673524], [27.530967955023566, 30.277495384124634], [19.788597672603842, 15.285564789166568], [19.186102546387584, 40.05102934694473], [12.072214158951471, 3.001764636530582], [17.445106409640204, 12.098159038651506], [13.684443919925407, 13.95427254439488], [17.434599626010673, 34.734922444941915], [45.06202907365123, 52.77977373689842], [24.68868387329279, 14.59414951252121], [9.685788158299289, 13.85014938522329], [26.517643481851035, 17.54090332661226], [14.084487962822836, 7.601062546360699], [12.06491291222244, 11.349614592484405], [12.463055352963982, 4.084137625846741], [10.726072515891904, 91.70763899666292], [29.29774411662405, 7.501354062896522], [96.14988427523438, 93.99211326954988], [43.69896733772923, 37.94220746271367], [11.305276834594682, 7.903984024307623], [11.824241621245452, 32.78107563543932], [11.598019280459878, 9.473853153008589], [10.212969191857306, 12.069811195300218], [35.31563143616616, 54.57353282209227], [20.91949754749499, 19.97854135736093], [14.310181776044335, 7.657026444392022], [23.077662541050465, 30.861965428885053], [17.633436229591382, 9.111902282233476], [18.1317130521327, 19.882418076794274], [21.64548848233258, 8.716202722446608], [25.888824691369507, 10.286175891609687], [7.431729533693663, 6.864886196941493], [7.219131400477533, 6.79833930592096], [22.2995463460041, 14.129252050716845], [16.980383081014274, 13.70636893415333], [26.58950327588753, 21.012217323572496], [33.57754939742055, 12.389386786267629], [22.831923501054032, 110.37040519140237], [32.75432559447036, 21.02951504086275], [37.61592403073588, 38.49353960234345], [13.542679933781583, 6.531964091694429], [12.370154934324766, 15.466536793640325], [6.509381427915205, 6.880213847978178], [14.503504004199062, 4.234278882525035], [19.760953499079687, 22.42575007714268], [12.044722490503148, 9.040242875144562], [40.02906296092193, 34.00952974046423], [20.381087577347433, 11.044020045596694], [17.53549155327666, 13.633474253190817], [29.405457918830926, 9.59142231484578], [9.449328738520773, 9.97940648417312], [10.41572607960056, 11.118488825605544], [11.716425604636935, 8.368297800534593], [16.68131171864459, 14.403123096761018], [14.987955304087176, 11.017400264474835], [34.44152794426156, 16.619514967530037], [18.710924572037264, 11.878559143636567], [12.66637554497215, 11.704102302910197], [11.50323364156239, 10.646418887063641], [19.1222316812206, 8.355978782406492], [18.72205835644159, 18.895341004983898], [110.53537776173218, 97.5759821656442], [8.465917620153679, 3.00760383296681], [30.016517453417705, 11.62973363739319], [19.203597076161454, 12.589925273510746], [11.284257369238695, 9.03668792070492], [18.083349639147443, 10.831460133101965], [24.435795067481777, 23.962818721437642], [8.265437607983037, 8.504507475879068], [18.112020777657385, 20.617067296536348], [69.54254337667153, 56.208898693058316], [23.325429929750182, 12.936475757346777], [19.678990532863306, 13.46754435550489], [20.847225920645105, 29.23615567552342], [44.46591952907965, 20.950126433010116], [25.884142741686627, 25.684079208148297], [14.860172391627039, 11.47089217994123], [6.902708492136437, 15.000678233842514], [10.481108440892502, 7.956024657361704], [45.485639684799175, 17.243787530743287], [12.642443762816871, 8.707004885336413], [18.708792549833994, 26.37068315007471], [10.442955923868661, 7.378832600513451], [7.091431718391663, 5.622023600853527], [22.93815501053653, 11.712794492382267], [21.97634250749261, 14.906016262053159], [15.284018945737229, 10.900924971237433], [39.38166441188536, 41.89395925453306], [20.628228816479364, 15.26154848443747], [31.127550942168824, 8.824668080156883], [21.127776049801486, 12.288732798446974], [19.64712048240562, 12.801207871088831], [51.14784678661216, 57.92986058369043], [17.289576620952154, 12.754690499586491], [18.236418579361295, 11.884411805719084], [6.597780326977273, 8.159631330564805], [12.352721012542952, 10.358630755961755], [10.786348676200191, 6.903059057224418], [17.86910936004527, 10.783127065176616], [9.623451472861802, 5.626948067610135], [16.23212467728856, 10.253105248550892], [14.933960260625962, 13.910475598134353], [11.174192418167431, 3.5808671821434563], [18.19982235614158, 6.7207854373118945], [45.08958334353319, 45.24960847474043], [18.495265476864365, 6.241457291746494], [9.604307830578076, 10.279497341729124], [17.34654511790504, 8.889311138169097], [22.983349615603444, 8.73204768195629], [14.971503360271184, 9.620276080254744], [33.15163874399178, 34.88612133697561], [15.480629594120275, 11.66050361988204], [22.441649358172736, 58.354943731573215], [17.97397852239507, 16.46397682233332], [27.147056677382704, 15.338329684848224], [19.406845704202613, 13.984999936876475], [14.106225117192286, 10.067783293963213], [26.912275000352654, 26.275013777397305], [11.028309212239789, 9.614849202456496], [31.610138445550746, 13.811464815174093], [40.94234343749338, 32.86935064320801], [34.05393524376061, 23.89681200550756], [67.94060750649739, 80.16403411308546], [9.980576360347525, 9.780265265809467], [16.311141081564703, 7.81560344184493], [21.456175804365238, 7.702565153604817], [15.201774292329175, 5.475015547482913], [7.34220178475923, 3.5523619123585917], [29.854757518545917, 15.35997535663773]]
		stops_variances = [[21.739696644487516, 4.3682543929659685], [12.027149431985741, 4.904111996912937], [56.63330035157895, 18.4827240963592], [24.98190510727319, 23.649093671660232], [38.27663681016494, 20.2239141562973], [13.644893985247629, 3.7585277424341093], [8.385738553079358, 3.244139551092413], [16.278036532406013, 14.284912627108605], [19.716310273083273, 17.494545434534174], [21.01183287097958, 17.914194190771365], [4.285186858457424, 4.169529157066858], [9.431649326774343, 4.746059390737551], [7.694615874920678, 14.276631865996995], [23.469422553818625, 6.752550589730089], [41.31186674293062, 29.274046949103184], [14.878506203412483, 11.852795823799873], [22.206850871167063, 19.345579732874835], [42.23520841500277, 13.812090771932716], [10.974624131431485, 8.294722697469718], [8.413381812285216, 4.816550887078889], [8.570871587355937, 4.345692342163201], [38.81646951779212, 36.55938763536899], [27.26728784127365, 23.30433527031746], [19.548558259463793, 11.374065777934556], [8.81454968122274, 6.842348872855051], [23.432928179377676, 5.462311890223755], [8.814577567659704, 8.08155568461454], [12.273869115020176, 6.82933736542866], [26.686883244355858, 16.288500178630127], [27.82729227609931, 14.098744609909511], [5.797313936537363, 5.398174740517058], [25.638617584616366, 25.19633838196158], [10.43392142742618, 9.646908801822967], [34.26071485370933, 7.35338845872808], [10.969190759579543, 7.908401642446462], [4.749100685869859, 3.4926496883236156], [40.14748857387473, 36.29161880928992], [25.53708874660263, 7.147523629704253], [20.409332996248377, 7.014671727727541], [22.52227035386793, 7.31895763660056], [19.533115815257826, 8.214526749902175], [19.181138752177244, 9.00510153132508], [50.386475587736776, 16.018759709836132], [14.517373816722607, 4.430330085574848], [13.600169383838082, 6.268148762681704], [15.750183517911177, 3.64910872672542], [16.66075350391544, 10.208723971386991], [18.970721636921184, 5.353173812878085], [8.403918856186188, 3.5586721459289774], [4.587580638310111, 2.5102794587782036], [23.099621416548885, 3.421581769814141], [18.47585966675728, 4.307925903557083], [11.096778910385222, 6.473910648740462], [38.41071523229996, 16.441590138531573], [30.749558017790708, 16.323646261614435], [15.94638083767749, 7.674974317742089], [51.14071630334388, 18.287003994590506], [4.024173043233416, 4.2932619534413], [9.957975818515346, 14.061319467726756], [10.294602866463032, 7.715810084861961], [16.48328472396625, 7.163321036484836], [10.707098436700246, 7.368553424453803], [50.534670784824606, 8.78964293485726], [19.055582448703724, 4.301505883562093], [7.809620522936602, 6.717375174994491], [18.18594349846924, 4.342743423715466], [20.137664009237646, 6.450472270032459], [10.729931699520284, 8.129615391184243], [10.514555316240303, 3.709099928071777], [33.155675576135785, 12.039145461072964], [8.613940179805423, 5.961769249433773], [15.154898943602626, 6.3417336232823285], [85.73150267143097, 24.79312772277236], [11.795989074447101, 5.150913571151397], [28.08257610867178, 22.96668286415552], [29.06666789168303, 6.0237295155773065], [35.13407036934163, 23.318012491082577], [12.600191624836219, 7.693578944730721], [24.925550126596917, 14.786923419142529], [5.582044024342074, 4.8484409518057765], [8.554735200628228, 5.666248321559429], [5.54245046451771, 5.276274056725795], [11.101231594792491, 7.166032877997539], [19.458010572417543, 18.70110232478572], [7.56055703828079, 5.927456212606875], [14.504890584276684, 4.216523947712128], [10.38578127447395, 6.963092881251057], [35.031274614629815, 9.177269278471021], [25.383135466397736, 4.129463662645185], [9.41916298726374, 9.097797871864378], [47.32267642535445, 32.5654127199614], [11.637856142801118, 13.56455754675636], [3.4922348802475893, 3.5797506282787332], [33.16584757547958, 18.98700064428791], [12.249360358888, 5.949554091180501], [6.235956639648354, 2.061371276489913], [18.891984865993834, 10.680680197793338], [24.012195565117633, 5.7950606376513925], [34.82180652301176, 28.526107763122276], [54.94487750502988, 50.71260073447184], [13.551176792871148, 61.091632419768], [7.574475368153669, 5.033195718835067], [9.529628234740189, 4.595871298792106], [11.059814489824156, 7.800248043174847], [45.24770225802569, 18.50770809299597], [25.148417524847105, 18.814389210079916], [3.898136585527022, 3.402476016888915], [15.065399368295024, 8.41111586247968], [7.616942636555072, 7.18769062717792], [5.08962371708017, 5.190064207657922], [29.646545118113785, 10.555825493109412], [4.2488743216766185, 3.9294632725261534], [32.2384250813709, 10.891045403872521], [9.602682852467247, 4.733723504290265], [3.5651879055526514, 2.84847902752411], [11.134351460916257, 6.692774874569362], [10.437269806970516, 5.626166854845631], [29.811122583281634, 19.023409974470574], [66.50395579664296, 65.0421116589776], [28.39273181953159, 25.10864294644297], [3.5424506630673105, 3.098497494333299], [24.856171632287975, 21.227294714484657], [21.144984443600524, 6.175498510965898], [18.88978514069628, 6.427052271115819], [5.513575315253235, 5.67720425629883], [24.849091873261987, 22.274640092821276], [59.95297760983366, 45.142446695925194], [4.6124410607995125, 3.5419563666429292], [18.69758316659146, 18.214974915881957], [3.14429721375824, 2.992746405762529], [20.60947594689388, 9.455208791753055], [12.54144255665895, 5.039965858943934], [16.530913609894895, 13.409512008580808], [12.12418050516637, 11.729224253450981], [5.740466437482936, 2.7694523203123023], [4.0566786004765785, 2.0634887064954968], [20.03466849946951, 4.333924290982831], [5.7496939924339925, 5.232527933862577], [17.988658289511385, 13.97439774447737], [21.834188160474874, 5.585595528941324], [55.02045791974604, 53.65898993757004], [12.287337816392393, 11.00171982910731], [5.5447478353689785, 5.040332894405735], [19.566647310984507, 5.132171624823607], [22.044662904301646, 4.46241642817763], [8.949459141339146, 4.284004249140373], [85.94510625415442, 78.85873270568018], [9.921251073574332, 5.07733325720637], [18.79631368404179, 3.112338735820001], [19.308773575953197, 8.653032266679563], [9.492419774336113, 3.887615545112259], [5.460331634945581, 3.898709241316236], [6.350577142770123, 4.462036362473127], [36.43859184916066, 27.69332589539151], [32.96106170004669, 22.738361100808763], [23.31972080449792, 21.736022412910287], [22.962093973916105, 8.193198261401669], [14.178475245137417, 12.18915296695168], [15.978838106018982, 29.94194137227661], [10.69232734235215, 2.5488588334004496], [16.21266036154598, 6.193831651556847], [8.921904692060053, 7.71972520587326], [16.859906197519972, 30.5388184083238], [42.98007977026451, 35.402045061220306], [23.18694480871496, 6.220131270970575], [8.794421346527677, 12.13192762538938], [21.316251279300648, 3.982797534018789], [13.801908613451888, 5.881541511318879], [9.179812765422248, 3.7123191334588133], [10.602339608147473, 2.9503340534670115], [10.329531744101525, 90.41677799422031], [28.416539463861664, 4.497715799217851], [35.96647872155096, 21.5739981310961], [30.192313506266814, 27.426227931264904], [9.771227028511685, 3.385882739835471], [11.283507857552946, 23.202716400546528], [6.954627291086126, 5.660652289890505], [6.786981081008513, 6.738629564038881], [17.8857132044561, 10.95720831703959], [8.032675172993878, 8.038168275244368], [13.963730126503497, 7.157305921536604], [21.664049526916774, 11.351006216641492], [15.57244152771487, 5.767676454439147], [13.023326622164126, 5.8022406344984], [18.845139579711066, 4.075075372906093], [23.718004878076908, 3.9083015840692164], [3.9989345511536043, 2.5432666900541974], [4.444246764992162, 2.3232057304492764], [21.857368331983587, 7.504085057918151], [12.599288667677984, 6.248973686145059], [19.11244896030881, 4.268165275552334], [32.953924422030575, 9.489507744101065], [19.60198725189539, 54.039822744586886], [31.783014913331563, 13.343005198620123], [39.82683059959536, 41.142221793354786], [12.09357800577627, 4.198262171320937], [11.334294200354078, 12.936589682658672], [4.776290673576885, 3.0947345886712077], [13.342407648897304, 2.732497223456839], [7.040300202261045, 14.18026118873343], [10.226083404811751, 3.3631414595271605], [37.016566188348506, 19.184220106799014], [20.203663758344106, 9.328511717488551], [12.393728856020493, 9.077684684091752], [26.022628094508, 4.572941558585803], [4.963926016118109, 2.6400206466097864], [4.944028351954694, 2.555245848279824], [11.190718370162166, 5.951740143762921], [9.699138326922387, 3.683628267686979], [13.616688929952918, 9.317467653795614], [31.57853826855646, 8.958229646959545], [16.882371977998986, 11.062261946538552], [9.699303885326007, 8.341154543922839], [6.6992770587671675, 5.4745405574846915], [18.37425689360312, 4.231555805527679], [15.20553373462533, 12.619855263580435], [91.51262462651796, 89.97109481266284], [7.815238086765808, 2.3330424336340427], [29.300671482106118, 4.479048306574666], [16.54697689175852, 4.678868362844771], [8.636771771541502, 7.005696934117333], [7.915194920312672, 3.7808733226619906], [19.094184473142782, 17.620575571333227], [5.55860027553457, 4.567859894327134], [15.299348263925594, 15.50422413816548], [69.63533165381584, 57.7792947274142], [20.046280474729148, 9.460523545547924], [15.700875068695836, 9.506133738283735], [18.599582444356475, 19.047533149044636], [42.28883829134491, 15.306240518708776], [21.382081680643527, 20.518716155344514], [13.131764272231518, 9.279723577467754], [6.424023739595152, 7.196261617545942], [7.440918807329309, 3.7908606336513055], [45.94257547381191, 10.929388297167767], [9.693624229419372, 5.165968125231748], [18.115075920124784, 13.943970549967018], [10.440219191025538, 7.373533008780567], [4.541475075069845, 4.1959912063040194], [21.247364792843698, 8.162324326972051], [9.852744433975799, 4.721738312111046], [14.08440957152626, 8.029750564315101], [33.4089220051741, 35.4984452223215], [18.021208083021374, 12.056182278265705], [29.66131070274842, 7.599616208727161], [14.269535219864338, 9.36399764289655], [14.067314910868781, 8.196014822490666], [52.89224123884184, 57.88485955864682], [14.06954374872491, 5.997397873678433], [13.358968750152398, 6.383401689328974], [6.151716236626135, 6.823874184456957], [12.007662600053225, 10.03317387129291], [10.653337937246095, 6.389685649138477], [12.790479497931427, 7.095981247312536], [9.496457138800098, 5.201828487594141], [13.504899115283175, 6.9649078695998], [11.745962412394515, 4.320381227775881], [9.662582393418575, 3.049996942362357], [15.232278230857366, 4.041900141434621], [42.86169897418484, 24.724468809140912], [17.468739790027314, 5.640402458001215], [9.2744896230877, 7.6577768477487655], [14.196461826019581, 5.144211923154504], [19.885559950062692, 5.353934209812985], [13.52805182719705, 3.102075851728504], [31.646305082073177, 30.735085131558066], [5.473107404104679, 4.763454346594472], [21.740368480183417, 23.882470576757985], [17.662341087443878, 15.232305530998527], [21.07589881682069, 7.222875740383419], [13.11475549893721, 3.06719779563178], [8.506450350762607, 3.4916466095089094], [6.9053315076122965, 5.451047799542924], [10.546701049739033, 4.426081328138179], [28.902018340974635, 7.318152805077347], [19.544625966994293, 7.298533239083819], [20.72066633236296, 14.969206988602041], [70.8185538985792, 70.9477484874784], [8.660278836209294, 5.3484816928656045], [12.882811065928472, 3.1847511640389117], [19.020903332223977, 4.611154820284145], [13.959090673970202, 4.2205329123068065], [5.585795237387532, 2.7664343030215224], [29.548965677078115, 14.456212974002206]]

		stops_variances = np.array(stops_variances)
		div = np.divide(stops_variances[:, 0], stops_variances[:, 1], where=stops_variances[:, 1] != 0)
		diff = stops_variances[:, 0] - stops_variances[:, 1]
		print('For ' + str(len([sv for sv in diff if sv >= 1])) + ' segments of trips is the new estimation better.')
		print('For ' + str(len([sv for sv in diff if sv >= 2])) + ' segments of trips is the new estimation significantly better.')
		print('For ' + str(len([sv for sv in diff if sv < 1])) + ' segments of trips is the new estimation worse.')
		print(diff.mean())
		print(diff.std())

		print(stops_variances[:,0].mean())
		print(stops_variances[:, 1].mean())

		print(stops_variances[:, 0].std())
		print(stops_variances[:, 1].std())

		bins_sv_1 = [0] * 10

		for i in range(len(stops_variances)):
			if stops_variances[i][0] > 90:
				bins_sv_1[9] += 1
			else:
				sv = int((stops_variances[i][0]) // 10)
				bins_sv_1[sv + 1] += 1

		plt.bar([(i) * 10 - 5 for i in range(10)], bins_sv_1, width=8)
		plt.xlabel('Směrodatná odchylka [s]')
		plt.ylabel('Počet dvojic zastávek')
		# plt.savefig('rozptyl_old.pdf')
		plt.show()
		plt.clf()

		bins_sv_2 = [0] * 10

		for i in range(len(stops_variances)):
			if stops_variances[i][1] > 90:
				bins_sv_2[9] += 1
			else:
				sv = int((stops_variances[i][1]) // 10)
				bins_sv_2[sv + 1] += 1

		plt.bar([(i) * 10 - 5 for i in range(10)], bins_sv_2, width=8)
		plt.xlabel('Směrodatná odchylka [s]')
		plt.ylabel('Počet dvojic zastávek')
		# plt.savefig('rozptyl_new.pdf')
		plt.show()
		plt.clf()

		bins_diff = [0] * 8

		for i in range(len(diff)):
			if diff[i] < -20:
				bins_diff[0] += 1
			elif diff[i] > 40:
				bins_diff[7] += 1
			else:
				sv = int((diff[i] + 20) // 10)
				bins_diff[sv + 1] += 1

		plt.bar([(i - 2) * 10 - 5 for i in range(8)], bins_diff, width=8)
		# plt.savefig('rozptyl_diff.pdf')
		plt.show()
		plt.clf()

		bins_div = [0] * 8

		for i in range(len(div)):
			if div[i] < 0.5:
				bins_div[0] += 1
			elif div[i] < 1:
				bins_div[1] += 1
			elif div[i] > 6:
				bins_div[7] += 1
			else:
				sv = int(div[i])
				bins_div[sv + 1] += 1
		bars = ['< 0.5', '0.5-1', '1-2', '2-3', '3-4', '4-5', '5-6', '6 <']
		# bars = ('A', 'B', 'C', 'D', 'E', 'F', 'E', 'G')
		y_pos = np.arange(len(bars))
		# plt.bar([(i - 2) * 10 - 5 for i in range(8)], bins_div, width=8)
		plt.bar(y_pos, bins_div)

		# use the plt.xticks function to custom labels
		plt.xticks(y_pos, bars, horizontalalignment='center')
		plt.show()

		# plt.hist(stops_variances[:, 1], density=False)
		# plt.show()

